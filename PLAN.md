# Atom Game 项目开发计划

## 一、技术选型

| 项目     | 选型        | 说明                     |
|----------|-------------|--------------------------|
| 语言     | Python 3.10+ | 便于快速迭代与规则调试   |
| 图形/输入 | Pygame      | 2D 渲染、事件、窗口管理  |
| 依赖管理 | pip + requirements.txt | 版本固定，便于复现 |

---

## 二、项目目录结构（规划）

```
atom_game/
├── RULES.md              # 规则说明（已创建）
├── PLAN.md               # 本计划文档
├── requirements.txt      # Python 依赖
├── README.md             # 项目说明与运行方式
├── main.py               # 程序入口，启动 Pygame 与主循环
├── src/
│   ├── __init__.py
│   ├── config.py         # 窗口尺寸、颜色、网格常数等
│   ├── game/
│   │   ├── __init__.py
│   │   ├── state.py      # 游戏状态：双方原子池、场地、生命、回合阶段等
│   │   ├── turn.py       # 回合流程：阶段 0/1/2/3 与阶段切换
│   │   └── combat.py     # 攻击力/防御力计算、破坏与连通分量结算
│   ├── grid/
│   │   ├── __init__.py
│   │   ├── triangle.py   # 正三角形网格：坐标、邻接、距离（竖向/横向）
│   │   └── cell.py      # 单格数据：格点上的原子、连通性检查
│   ├── atoms/
│   │   ├── __init__.py
│   │   └── draw.py      # 抽原子随机（黑 0.5，红/蓝/绿 各 1/6）
│   └── ui/
│       ├── __init__.py
│       ├── board.py     # 绘制双方场地与三格
│       ├── grid_render.py # 三角网格与格点、原子绘制
│       └── hud.py       # 生命、原子池、阶段与操作提示
├── assets/               # 可选：贴图、字体
└── tests/                # 单元测试（网格、战斗、抽原子等）
    ├── __init__.py
    ├── test_grid.py
    ├── test_combat.py
    └── test_atoms.py
```

---

## 三、开发阶段

### Phase 1：框架与网格（当前优先）

1. **项目骨架**
   - 创建 `requirements.txt`（pygame），`main.py` 打开窗口与主循环，退出与基础事件处理。
2. **配置**
   - `config.py`：窗口宽高、FPS、颜色常量、三角形边长与高（1, √3/2）。
3. **正三角形网格**
   - `grid/triangle.py`：定义格点索引与直角/仿射坐标的转换，实现“相邻”（共享边）、竖向距离（单位 √3/2）、横向距离（单位 1）。
   - `grid/cell.py`：单格状态（格点 → 原子颜色），放置/移除原子，连通性检查（BFS/DFS）。
4. **最小可运行**
   - 在窗口内绘制一方的一个格子（三角网格 + 格点），不要求交互。

### Phase 2：游戏状态与回合逻辑

1. **状态**
   - `game/state.py`：双方原子池（四色计数）、生命值、双方各 3 个格子（每格一个 cell）、当前玩家、当前阶段、本回合“获得原子数 / 可放置数 / 可攻击次数”。
2. **回合**
   - `turn.py`：阶段 0（选 a/b/c）→ 阶段 1（抽原子）→ 阶段 2（放置）→ 阶段 3（进攻与效果），先手第一回合禁止进攻。
3. **抽原子**
   - `atoms/draw.py`：按黑 0.5、红/蓝/绿 各 1/6 随机生成原子列表。
4. **无 UI 验证**
   - 用简单脚本或测试跑通：初始状态 → 阶段 0 选择 → 抽原子 → 放置校验（连通、每格至少一黑）。

### Phase 3：战斗与效果

1. **攻击力/防御力**
   - `combat.py`：按规则计算进攻格攻击力、防守格防御力；比较后决定是否可指定破坏。
2. **破坏与连通分量**
   - 破坏一个黑原子后，对防守格做连通分量分解；防守方选择保留含黑的连通分量，其余清除；若无含黑分量则全清。
3. **红/蓝/绿效果**
   - 移除原子时计算与黑原子的连边数 y，执行：红 → 对方选 y 个破坏（含整格清空规则）；蓝 → 己方 +y 黑；绿 → 己方 +y 生命。
4. **直接攻击玩家**
   - 对方三格全空时，伤害 = 进攻格攻击力，无防御修正。
5. **单元测试**
   - `tests/test_combat.py`、`tests/test_grid.py`、`tests/test_atoms.py` 覆盖核心逻辑。

### Phase 4：UI 与交互

1. **场地与网格**
   - `ui/board.py`、`ui/grid_render.py`：绘制双方 3 格、三角网格、格点与原子颜色。
2. **HUD**
   - `ui/hud.py`：生命值、原子池、当前阶段、本回合可放置数/可攻击次数、操作提示。
3. **交互**
   - 阶段 0：选择 a/b/c（按钮或键）。
   - 阶段 2：选择原子池中的原子 → 点击己方格点放置，校验连通与每格至少一黑。
   - 阶段 3：选择进攻（己方格 → 对方格）或发动效果（选择己方一个彩原子移除）；进攻时选择要破坏的黑原子、防守时选择保留的连通分量（若出现）。
4. **流程衔接**
   - 阶段结束后自动或按钮进入下一阶段；回合结束切换玩家，先手第一回合禁用进攻按钮/逻辑。

### Phase 5：打磨与收尾

- 胜负判定与结束界面。
- 音效与简单动画（可选）。
- 规则说明入口（可链接到 RULES.md 或内置简版）。
- 代码整理、注释与 README 更新。

---

## 四、当前执行

- 已创建 **RULES.md**（规则说明）。
- 已创建 **PLAN.md**（本计划）。
- 已创建 **requirements.txt**（pygame）、**README.md**、**main.py**。
- 已实现 **Phase 1** 骨架：
  - **src/config.py**：窗口、颜色、三角网格常数。
  - **src/grid/triangle.py**：格点索引、邻接、竖向/横向距离（单位 √3/2 与 1）。
  - **src/grid/cell.py**：单格原子放置/移除、连通性、连通分量、与黑原子邻接数。
  - **src/ui/grid_render.py**：在指定 rect 内绘制正三角形网格与格点（及原子）。
  - **src/atoms/draw.py**：按黑 0.5、红/蓝/绿 各 1/6 随机抽原子。
  - **src/game/**、**src/ui/board.py**、**hud.py** 为占位，供 Phase 2～4 实现。
- 运行方式：`python main.py`（关闭窗口或 ESC 退出）。
- **Phase 2～4 已实现**：
  - **state.py**：双方原子池、生命、各 3 格、阶段与回合限制；**turn.py**：阶段 0 选 a/b/c、阶段 1 抽原子、阶段 2 放置校验与结束排布、回合结束。
  - **combat.py**：攻击力/防御力、格对格攻击结算（破坏黑原子、连通分量）、直接攻击、红/蓝/绿效果。
  - **main.py**：串联状态与回合；阶段 0 按 1/2/3 选择效果并自动进入排布；阶段 2 按 1～4 选颜色、点击己方格子放置、Enter 结束排布；阶段 3 按 E 结束回合。**board** 绘制双方 6 格，**hud** 显示生命/原子池/阶段与提示。
- **阶段 3 进攻与效果 UI** 已实现（选己方格→对方格、选黑原子/保留连通分量、红/蓝/绿效果；先手首回合不可进攻提示）。
- **网格绘制**：仅连接几何距离为 1 的节点，无错误对角线。
- **中文显示**：`config.get_font()` 优先使用系统 CJK 字体。
- **单元测试**：`tests/test_grid.py`、`tests/test_combat.py`、`tests/test_atoms.py`，`python -m pytest tests/ -v`。
- **UX**：阶段 3 选中进攻格时该格高亮边框。
- **README**：运行方式与操作说明已补充。
- 下一步（可选）：Phase 5 打磨（音效、规则说明入口、红效果多目标破坏扩展等）。
