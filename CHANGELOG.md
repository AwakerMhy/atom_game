# Changelog

## [1.14.0] - 2026-02-25

### 新增 / 改动

- **开始界面**：主界面改为「主游戏」「进入 AI 对战」两个入口；点击「进入 AI 对战」后进入关卡选择（第一关 / 第二关），再进入对应关卡的配置与准备界面；配置页可「返回选择关卡」回到关卡选择。
- **AI 操作展示时间倍数**：AI 对战模式下新增「AI 操作展示速度」选项，可调展示时间倍数（0.25～4，默认 1）；倍数调大时排布每步间隔、进攻高亮时长、行动间隔等均同比例放大，便于观察 AI 每一步操作。
- **AI 对战第二关**：新增第二关（AI 使用黑/红/蓝）；可配置 AI 每回合获得原子数、每回合可排布数、黑/红/蓝抽取权重；AI 排布时红/蓝优先放在与黑临边最多的格点；行动阶段可发动红效果（目标选玩家防御最高格）、蓝效果（优先保护攻击力高的格），再执行进攻；第一关保留不变。

---

## [1.13.0] - 2026-02-25

### 修复

- **排布 · 已放计数**：修复单次放置（非批量）红/蓝/绿/黄/紫/白/灰原子时「排布 · 已放」不更新的问题。原因为在共享引用的 state 上调用会原地修改的函数（如 `applyPlace`），React 未收到新 state 引用导致部分 UI 不重渲染。现改为不可变更新：校验后用克隆的 cell 执行放置、用新 `cells`/`pools`/`placementHistory` 构造全新 state 再返回，确保 HUD 计数与格子同步刷新。

---

## [1.12.0] - 2026-02-25

### 新增 / 改动

- **AI 对战**：AI 进攻阶段分步显示（每步 400ms），不再一次性执行完；AI 格子被攻击/红效果破坏产生多连通子集时自动保留「黑原子数最多」的子集，不再弹窗；修复回合交还玩家时被覆盖导致卡在 AI 回合的问题（依赖 `turnAttackUsed` 触发下一轮 timeout）。
- **AI 排布**：AI 与玩家一致——只选「往哪格放几个」黑原子，具体格点用与玩家相同的 `batchPlaceOnCell` 随机生成；排布后该格视角自动平移到放置原子附近（`aiPlaceFocusCell` + Board pan）。
- **排布限制与撤回**：本回合排布数统一以 `placementHistory` 为唯一来源同步 `turnPlacedCount`，不再对 history 做 slice 截断，避免非黑放置未计入或无法撤回；进入排布分支时用 `placementHistory.length` 判断是否达上限；AI 对战下玩家非黑原子也计入本回合排布数并受同一上限限制，当回合可撤回非黑排布。
- **其他**：玩家效果/进攻导致 AI 格需选连通子集时立即自动应用（保留黑最多），不切换 currentPlayer，避免误伤玩家原子；排布阶段上限提示文案统一为「黑/红/蓝/绿/黄/紫/白/灰合计」。

---

## [1.11.0] - 2026-02-25

### 新增 / 改动

- **AI 对战模式**：新增「AI 对战」；第一关为玩家（P0）对战仅使用黑原子的 AI（P1）；可配置 AI 每局获得黑原子数、每回合可排布黑原子数；AI 随机排布后按规则进攻（攻>防、黄顺序），无可进攻格子后结束回合。
- **规则**：灰原子与红/蓝/绿/黄/紫一致，无黑邻居时也会被破坏；一个格子不能对防御力不低于己方攻击力的对方格子发动进攻；黄持续效果中进攻与红效果共用「已完成」顺序（已进攻或已发动红效果即算完成）。
- **排布与计数**：每回合可排布原子数为「所有颜色原子数之和」的上限；排布阶段达上限后不可再放置任何颜色；「排布 · 已放」显示所有类型放置合计，并与 placementHistory 同步；黑原子只能放在已有黑原子的邻居格点上。
- **规则文案**：开始界面与 HUD 中明确「所有颜色合计」、可排布原子数含义；破坏后连通规则补充步骤(4) 红/蓝/绿/黄/灰无黑邻居则被破坏。

---

## [1.10.0] - 2026-02-24

### 新增 / 改动

- **灰原子**：新增灰原子；排布阶段可放置到对方格子中黑原子的邻居格点上；该格子内黄原子持续效果无效（进攻/红效果顺序按 0 黄处理）。
- **灰原子点击效果**：点击灰原子发动效果后，其同格邻居格点在下一回合内无法发动其他原子点击效果；沉默区域以灰色高亮显示；发动前可预览沉默范围。
- **修复**：同一回合发动多次灰效果时，沉默区域合并、结束回合取较晚者，不再被后一次覆盖。

---

## [1.9.0] - 2026-02-19

### 新增 / 改动

- **规则说明**：黄的持续效果补充为「对方必须以有黄原子的格子为攻击对象和红原子的效果对象」。
- **进攻交互**：玩家点选要发动进攻的己方格子后，右侧新增「取消选择」按钮，可取消本次选择。
- **效果发动交互**：点击红/蓝/绿/黄原子发动效果时，先高亮该原子，右侧出现「确认发动」「取消」按钮，确认后再执行效果（红为再选对方格）。
- **开始界面**：各原子抽取权重设置移至右侧；新增「规则」按钮，可查看规则摘要；权重中「黑」字用黑色背景徽章与其他颜色格式一致。
- **修复**：修正 `updateState` 在 `handleEffectConfirm` 之前的初始化顺序，消除 ReferenceError。

---

## [1.8.0] - 2026-02-19

### 新增 / 改动

- **紫原子**：新增紫原子；放置规则与红/蓝/绿/黄一致，须与至少一个已有黑原子相邻；紫无点击效果。
- **紫原子作用**：紫扩展具有特殊效果原子（红/蓝/绿/黄）的黑邻跳数。与紫相邻时，有效黑邻按「1 + 相邻紫个数」跳计算；多紫连接同一红/蓝/绿/黄时跳数叠加。
- **发动效果时紫消失**：绿/蓝/黄被点击发动效果时，与该格相邻的紫原子一并消失。
- **规则说明**：规则 overlay 中补充紫的放置、作用、多紫叠加及「绿/蓝/黄发动效果时相邻紫一并消失」的说明。

---

## [1.7.0] - 2026-02-22

### 新增 / 改动

- **开始界面**：新增「双方玩家血量」（1~99）、「双方格子数目」（2~6）可调选项。
- **进攻确认**：选择己方格与对方格后弹出「确认进攻？」并绘制进攻箭头；可取消，取消后需重新选择进攻格。
- **进攻无效不消耗**：防御力≥攻击力或对方格无黑原子时进攻无效，该格本回合仍可再次进攻。
- **黑原子排布**：单格放置黑原子时须与已有黑原子相邻（与批量放置规则一致）。
- **修复**：修正 `updateState` 初始化顺序；移除 `turn.js` 未使用的 `playerCells` 导入。

---

## [1.6.1] - 2026-02-22

### 新增 / 改动

- **撤回规则**：排布阶段撤回仅能撤回红/蓝/绿/黄原子，黑原子不可撤回。
- **排布规则**：红/蓝/绿/黄原子必须与至少一个已有黑原子相邻才能放置；规则说明已更新。

---

## [1.6.0] - 2026-02-22

### 新增 / 改动

- **游戏开始界面**：新增 StartScreen，可配置每局获得原子数、可排布原子数、各原子抽取权重（黑/红/蓝/绿/黄），点击「开始游戏」后按配置开局；支持「主菜单」返回并记忆上局配置。
- **音效**：原子破坏、效果发动、点击等事件均有音效（Web Audio API 合成，无需外部文件）。
- **动画**：原子破坏时虚化淡出；蓝/绿/黄效果发动时闪动；进攻与红效果破坏时播放破坏音效。
- **场地分界线**：双方场地间分界线延长，视觉更清晰。

---

## [1.5.0] - 2026-02-19

### 新增 / 改动

- **破坏后连通规则**：每批原子被破坏后，(1) 检查该格剩余原子是否连通，不连通则由被破坏方选择保留一个连通子集；(2) 仅看黑原子是否连通，若存在多个黑原子连通子集则由被破坏方选择保留一个，未选中的黑连通子集全部破坏；(3) 再自动清除所有「不包含黑原子」的连通子集。进攻与红效果均按此流程结算。
- **批量放置黑原子**：新增黑原子必须与现有某个黑原子相邻（格内无黑时第一个可放在中心或与任意原子相邻作为种子，其后均须与黑相邻）。

---

## [1.4.0] - 2026-02-19

### 新增 / 改动

- **进攻次数**：每回合可进攻次数 = 己方「有黑原子的格子」数（结束排布时确定）。
- **规则明细**：规则 overlay 中补充「原子持续性效果」（黑/红/蓝/绿各自持续作用说明）。
- **批量放置**：数量改为滑条调节；面板加大、选格按钮均布、取消按钮区分颜色；放置时保证与已有原子（含红/蓝/绿）连通。
- **确认弹窗**：结束排布、结束回合前弹出「是否确认」；直接攻击确认弹窗点击「是/否」可正常响应。
- **红效果**：发动前需先选择对方一个格子（窗口），破坏仅作用于该格。
- **开局选项**：默认勾选「随机破坏」与「批量随机布置黑原子」。

### 修复

- 攻击/红效果结算后：无黑原子的格子整格清空；多连通分量时先自动清除不含黑的子集，再让被攻击方选择保留哪一块（若已无多块则无需选择）。
- 直接攻击确认弹窗无反应：移除提前消费点击的逻辑，使「是/否」点击可正确处理。

---

## [1.3.0] - 2026-02-19

### 新增 / 改动

- **阶段 0**：三选一按钮改为左侧竖排，位于拖拽原子列右侧；不再使用居中弹窗。
- **HUD**：血条旁增加玩家头像（圆形 P0/P1）；血条上方移除重复的 P0/P1 文字；回合状态框与操作提示框分色（蓝灰/绿灰）、位置上移；操作提示框加宽并支持文字换行。
- **阶段 3 提示**：操作框中写明红/蓝/绿效果数目（红=破坏y个对方黑原子，蓝=得y黑，绿=回y血，y=邻黑数）。
- **场地**：每格下方显示 ATK/DEF；无原子格点缩小且颜色变浅；格子间距与双方场地上下间距加大；整体场地右移。
- **排布阶段**：原子池与撤回/结束排布竖排于屏幕左侧；颜色块仅显示数字；结束排布按钮加宽。
- **红效果规则**：仅能破坏对方黑原子；防守方选择要破坏的黑原子（红高亮），可再点撤销；选够后点「确认」；对方黑原子不足 y 时选满即可确认。
- **攻击**：选择进攻格后点击对方空格子会正确造成直接伤害。
- **破坏结算**：每次破坏原子后移除无黑原子的连通分量；若产生多个连通分量则由被破坏方选择保留哪一块。
- **破坏反馈**：原子被破坏时播放专用音效与扩散淡出动画。

### 修复

- 攻击时点击对方空格子无反应：为「对方格为空」分支施加直接伤害并结束本次进攻。

---

## [1.2.0] - 2026-02-19

### 新增 / 改动

- **拖动视角**：新增「拖动视角」按钮，开启后可在任意格子内按住拖动，整格几何（六边形、网格、原子）随视窗移动。
- **连续滑动**：拖动时网格相对屏幕平滑连续滑动（像素级偏移），不再按整格顿挫。

---

## [1.1.0] - 2026-02-19

### 新增 / 改动

- 网格规模：每格为 41×41 背板，可放置区域限定为**大正六边形**（半径 18 环），仅六边形内可放原子。
- 三角形边长固定为格子边长的 1/4；视窗 14×14，初始居中于六边形。
- 格子外遮蔽：六边形外区域用边框色填充，网格与背景仅在六边形内显示。
- 移除「拖动视角」逻辑与按钮，简化交互。

### 修复

- 拖动原子到格点松手无法放置：`screen_to_grid` 对越界 (r,c) 做钳位，保证格内松手总能得到有效格点。

---

## [1.0.0] - 2025-02-19

### 新增 / 改动

- 双人回合制原子对战：3 格场地、黑/红/蓝/绿原子、阶段 0（选效果）/2（排布）/3（动作）。
- 界面：双方场地居中；每格带边框与米色背景；原子缩小显示；拖动原子时无外框幽灵。
- 排布阶段：本回合新放原子高亮；支持「撤回」按钮，确定布置前可撤销。
- 动作阶段：进攻与红/蓝/绿效果点击交互完整（选黑原子破坏、额外破坏、选连通区域、红效果选目标）。
- 绿原子回血：血量满时也可继续加血。
- 音效：放置、进攻、效果、回合结束、点击、撤回等事件均有音效；无 ogg 时使用程序合成（需 numpy）。
- 拖动视角：每格支持「拖动视角」模式，在格内拖动可平移网格显示。
- HUD：血条与原子数量图形面板（当前玩家高亮）。

### 修复

- 阶段 3 点击格子未响应：用 consumed 标志区分按钮与格子点击，保证进攻/效果交互生效。
- 进攻时「点击破坏黑原子」未响应：将 attack_choose_black 分支从 attack_choose_extra 内移出为同级 elif。
